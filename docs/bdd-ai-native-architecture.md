# BDD + AI Native 架构设计

## 整体架构视图

### 1. 四层架构模型（更新：强调 SDD 层）

```
┌─────────────────────────────────────────────────────────────┐
│                    业务场景层 (What)                          │
│  ┌────────────────────────────────────────────────────┐     │
│  │  BDD 场景库 (Gherkin)                               │     │
│  │  - 业务规则                                          │     │
│  │  - 验收标准                                          │     │
│  │  - 领域语言                                          │     │
│  └────────────────────────────────────────────────────┘     │
└───────────────────┬─────────────────────────────────────────┘
                    │ 可执行规约
                    ↓
┌─────────────────────────────────────────────────────────────┐
│            ⭐ SDD 规则层 (How) - 核心竞争力                    │
│  ┌────────────────────────────────────────────────────┐     │
│  │  Skill 定义库                                        │     │
│  │  ┌──────────────────┐  ┌──────────────────┐        │     │
│  │  │  Domain Skill    │  │   Test Skill     │        │     │
│  │  │  ─────────────   │  │  ──────────────  │        │     │
│  │  │  • 架构模式      │  │  • 步骤定义模板  │        │     │
│  │  │  • 领域模型映射  │  │  • 参数提取规则  │        │     │
│  │  │  • 业务规则库    │  │  • 断言模式      │        │     │
│  │  │  • 代码生成模板  │  │  • 上下文管理    │        │     │
│  │  │  • 命名规范      │  │  • 命名规范      │        │     │
│  │  └──────────────────┘  └──────────────────┘        │     │
│  └────────────────────────────────────────────────────┘     │
└───────────────────┬─────────────────────────────────────────┘
                    │ 转换规则
                    ↓
┌─────────────────────────────────────────────────────────────┐
│                   AI 执行层 (Execute)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 业务代码生成 │  │ 测试代码生成 │  │ 文档生成     │         │
│  │ ─────────   │  │ ───────────  │  │ ─────────   │         │
│  │ • Service   │  │ • Step Defs │  │ • API Spec  │         │
│  │ • Domain    │  │ • Unit Test │  │ • Swagger   │         │
│  │ • Controller│  │ • API Test  │  │ • ER Diagram│         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                              │
│  按 Skill 规则生成：规范、统一、可维护                       │
└───────────────────┬─────────────────────────────────────────┘
                    │ 生成的制品
                    ↓
┌─────────────────────────────────────────────────────────────┐
│                  运行时验证层 (Verify)                         │
│  ┌────────────────────────────────────────────────────┐     │
│  │  持续验证引擎                                         │     │
│  │  - 自动化测试执行                                      │     │
│  │  - 场景覆盖度分析                                      │     │
│  │  - 需求追溯矩阵                                        │     │
│  │  - Skill 质量度量                                     │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

**关键更新**:
- ⭐ **新增 SDD 规则层**: 这是连接 BDD 和 AI 的核心桥梁
- **Domain Skill**: 指导业务代码生成
- **Test Skill**: 指导测试代码生成
- **AI 从"生成层"变为"执行层"**: 强调 AI 按规则执行，而非自主决策

---

## 2. 研发流程对比

### 传统瀑布流程
```
需求分析 (5天)
    ↓
架构设计 (3天)
    ↓
接口设计 (2天)
    ↓
编码实现 (10天)
    ↓
单元测试 (3天)
    ↓
集成测试 (3天)
    ↓
验收测试 (2天)
    ↓
部署上线 (1天)

总计: 29天
特点: 串行、等待、返工多
```

### BDD + AI Native 并行流程
```
    BDD 场景编写 (1天)
           ├────────────────────┬────────────────────┐
           ↓                    ↓                    ↓
    AI 生成代码 (4h)      AI 生成测试 (4h)    AI 生成文档 (4h)
           ├────────────────────┴────────────────────┤
           ↓                                          ↓
    人工审查代码 (1天)                          前端并行开发 (3天)
           ↓                                          ↓
    自动化测试 (0.5天)                          Mock 数据调试
           ├────────────────────┬────────────────────┘
           ↓                    ↓
    集成验证 (0.5天)       端到端测试 (1天)
           └────────────────────┘
                    ↓
             部署上线 (0.5天)

总计: 5天 (效率提升 83%)
特点: 并行、自动化、快速反馈
```

---

## 3. 数据流与控制流

### 需求到代码的数据流（更新：包含 SDD）
```
┌──────────────────────┐
│  业务需求              │
│  "价格调整需要审批"    │
└──────────┬───────────┘
           ↓
┌──────────────────────┐
│  BDD 场景 (Gherkin)   │
│  场景: 价格调整审批    │
│    假如 创建变更单     │
│    当 金额超过30%     │
│    那么 需要审批       │
└──────────┬───────────┘
           ↓
┌──────────────────────────────────────┐
│  ⭐ 加载对应 Skill 定义                 │
│  ────────────────────                │
│  Domain Skill: pricing-management   │
│  - 架构: DDD                         │
│  - 实体: PriceChangeOrder            │
│  - 规则: amount > 30% → approval     │
│                                      │
│  Test Skill: test-automation        │
│  - 步骤模板: Given/When/Then         │
│  - 断言模式: success_assertion       │
└──────────┬───────────────────────────┘
           ↓ AI 按 Skill 规则解析
┌──────────────────────┐
│  结构化需求 + 生成规则  │
│  {                    │
│    entity: "PriceChangeOrder" (from Domain Skill) │
│    rule: "amount > 30% → approval" (from Domain Skill) │
│    architecture: "DDD" (from Domain Skill) │
│    step_template: "@当(...)" (from Test Skill) │
│  }                    │
└──────────┬───────────┘
           ↓ AI 按模板生成
┌──────────────────────┐
│  领域模型              │
│  /**                  │
│   * 来源: Domain Skill │
│   */                  │
│  class PriceChangeOrder { │
│    approve() { ... }  │
│    validateThreshold() │
│  }                    │
└──────────┬───────────┘
           ↓
┌──────────────────────┐
│  服务层                │
│  /**                  │
│   * 来源: Domain Skill │
│   */                  │
│  class PricingService { │
│    createOrder() { }  │
│  }                    │
└──────────┬───────────┘
           ↓
┌──────────────────────┐
│  测试步骤定义           │
│  /**                  │
│   * 来源: Test Skill  │
│   */                  │
│  @当("金额超过30%")    │
│  public void 金额超过() │
└──────────────────────┘
```

**关键变化**:
- 在 BDD 场景和 AI 生成之间，插入了 **Skill 加载和规则应用** 步骤
- AI 不再"自主决策"，而是"按 Skill 规则执行"
- 生成的代码标注来源 Skill，实现完整追溯

### 持续验证的反馈环
```
                 BDD 场景
                     ↓
              ┌──────────────┐
              │  AI 生成代码   │
              └──────┬─────────┘
                     ↓
              ┌──────────────┐
              │  自动化测试    │
              └──────┬─────────┘
                     ↓
                   结果?
               ╱           ╲
          ✅ Pass         ❌ Fail
         ╱                    ╲
    需求实现正确           差距分析
         │                    │
    部署上线              ┌─────┴─────┐
                         │           │
                    修改 BDD 场景   优化 AI 生成
                         │           │
                         └─────┬─────┘
                               │
                          重新生成代码
                               ↓
                          自动化测试
```

---

## 4. 关键组件设计

### 4.1 Skill 定义管理器（新增核心组件）
```
输入: BDD 场景特征
      ↓
┌─────────────────────┐
│  Skill 识别          │
│  - 根据场景关键词    │
│  - 识别所需 Skill    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  Skill 加载          │
│  - Domain Skill     │
│  - Test Skill       │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  规则提取            │
│  - 架构模式          │
│  - 领域模型          │
│  - 业务规则          │
│  - 代码模板          │
│  - 测试模板          │
└──────────┬──────────┘
           ↓
输出: Skill 规则集合
```

**Skill 定义结构**:
```yaml
skill_name: 用户管理
version: 1.0.0
domain_skill:
  architecture: DDD
  entities: [User, Email, Password]
  business_rules:
    - email_validation: "正则表达式"
    - password_strength: "8字符+数字+特殊字符"
  code_templates:
    - entity_template: "..."
    - service_template: "..."

test_skill:
  framework: Cucumber
  step_templates:
    - given: "@假如(\"...\")"
    - when: "@当(\"...\")"
    - then: "@那么(\"...\")"
  assertion_patterns:
    - success: "assertThat(...).isTrue()"
```

### 4.2 BDD 场景解析器
```
输入: Gherkin 场景文件
      ↓
┌─────────────────────┐
│  词法分析             │
│  - 识别关键字         │
│  - 提取参数           │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  语义分析             │
│  - 构建 AST          │
│  - 类型推断           │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  领域模型映射          │
│  - 实体识别           │
│  - 关系推断           │
└──────────┬──────────┘
           ↓
输出: 结构化需求模型
```

### 4.3 AI 代码生成引擎（按 Skill 规则执行）
```
输入: 结构化需求模型 + Skill 规则
      ↓
┌─────────────────────┐
│  ⭐ Skill 规则应用    │
│  - 加载 Domain Skill │
│  - 加载 Test Skill   │
│  - 提取代码模板       │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  业务代码生成         │
│  - Domain Layer      │
│    (按 Domain Skill) │
│  - Service Layer     │
│  - Controller Layer  │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  测试代码生成         │
│  - Step Definitions  │
│    (按 Test Skill)   │
│  - Unit Tests        │
│  - API Tests         │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  质量检查            │
│  - Skill 规范验证    │
│  - 代码规范检查      │
└──────────┬──────────┘
           ↓
输出: 完整项目代码 (带 Skill 追溯)
```

**关键点**:
- AI 不再自主决策，而是严格按 Skill 规则执行
- 每段生成的代码都标注来源 Skill
- Skill 规则确保代码质量和一致性

### 4.4 质量保证系统（新增 Skill 质量度量）
```
┌─────────────────────────────────────┐
│         质量门禁                      │
├─────────────────────────────────────┤
│  ⭐ 0. Skill 规则质量检查              │
│     - Skill 定义完整性               │
│     - Domain Skill 覆盖核心领域      │
│     - Test Skill 模板有效性          │
│     - Skill 版本兼容性               │
│                                     │
│  1. 场景覆盖度检查                    │
│     - 核心业务流程 100% 覆盖          │
│     - 异常场景覆盖率 > 80%            │
│                                     │
│  2. 代码质量检查                      │
│     - Sonar 扫描通过                 │
│     - 代码复杂度 < 15                │
│     - 测试覆盖率 > 80%               │
│     - Skill 规范符合率 > 95%         │
│                                     │
│  3. 需求追溯性检查                    │
│     - 每个场景有对应实现              │
│     - 每个实现有对应测试              │
│     - 每段代码有 Skill 来源追溯      │
│                                     │
│  4. 性能基准检查                      │
│     - API 响应时间 < 200ms           │
│     - 并发处理能力测试                │
└─────────────────────────────────────┘
```

---

## 5. 技术栈选型

### 推荐技术栈
```
┌─────────────────────────────────────────┐
│  BDD 场景层                              │
│  - Cucumber (Java/JavaScript)           │
│  - SpecFlow (.NET)                      │
│  - Behave (Python)                      │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  ⭐ SDD 规则层                            │
│  - YAML/JSON Skill 定义                 │
│  - Git 版本管理                          │
│  - Skill 市场/仓库                       │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  AI 执行层                               │
│  - Claude Code / GitHub Copilot         │
│  - OpenAI Codex                         │
│  - 自定义 LLM Fine-tuning               │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  应用层                                  │
│  - Spring Boot (Java)                   │
│  - NestJS (Node.js)                     │
│  - FastAPI (Python)                     │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  测试层                                  │
│  - JUnit / TestNG                       │
│  - Karate (API Testing)                 │
│  - Playwright (E2E)                     │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────┐
│  DevOps 层                               │
│  - Jenkins / GitLab CI                  │
│  - Docker / Kubernetes                  │
│  - Prometheus / Grafana                 │
└─────────────────────────────────────────┘
```

---

## 6. 部署架构

### 开发环境
```
┌──────────────────────────────────────┐
│  开发者本地环境                        │
│  ┌────────────────────────────────┐  │
│  │  IDE (IntelliJ / VS Code)      │  │
│  │  + Claude Code Plugin          │  │
│  │  + Cucumber Plugin             │  │
│  └────────────────────────────────┘  │
│                ↕                      │
│  ┌────────────────────────────────┐  │
│  │  本地测试运行器                  │  │
│  │  - Cucumber JVM                │  │
│  │  - Test Containers             │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
```

### 集成环境
```
┌──────────────────────────────────────┐
│  CI/CD Pipeline                      │
│  ┌────────────────────────────────┐  │
│  │  1. Git Push 触发               │  │
│  │  2. BDD 场景验证                │  │
│  │  3. AI 代码生成                 │  │
│  │  4. 自动化测试                   │  │
│  │  5. 质量门禁检查                 │  │
│  │  6. 部署到测试环境               │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
                ↓
┌──────────────────────────────────────┐
│  测试环境 (Kubernetes)                │
│  ┌──────────┐ ┌──────────┐          │
│  │ Service  │ │ Service  │          │
│  │  Pod     │ │  Pod     │          │
│  └──────────┘ └──────────┘          │
│                                      │
│  ┌──────────────────────────────┐   │
│  │  共享服务                      │   │
│  │  - PostgreSQL                │   │
│  │  - Redis                     │   │
│  │  - RabbitMQ                  │   │
│  └──────────────────────────────┘   │
└──────────────────────────────────────┘
```

---

## 7. 监控与度量

### 效能看板
```
┌─────────────────────────────────────────┐
│  研发效能度量                             │
├─────────────────────────────────────────┤
│                                         │
│  📊 需求交付周期                          │
│  ████████████░░░░░░░░ 5天 (目标: 7天)    │
│                                         │
│  ⭐ Skill 规则复用率                      │
│  ██████████████████░░ 68% (目标: 60%)   │
│                                         │
│  📊 AI 代码生成占比                       │
│  ███████████████████░ 75% (目标: 70%)   │
│                                         │
│  📊 BDD 场景覆盖率                        │
│  ██████████████████░░ 85% (目标: 80%)   │
│                                         │
│  📊 自动化测试通过率                      │
│  ████████████████████ 98% (目标: 95%)   │
│                                         │
│  📊 需求-代码追溯率                       │
│  ████████████████████ 100% (目标: 100%) │
│                                         │
└─────────────────────────────────────────┘
```

### 质量看板
```
┌─────────────────────────────────────────┐
│  质量度量                                 │
├─────────────────────────────────────────┤
│                                         │
│  🐛 生产缺陷率                            │
│  ███░░░░░░░░░░░░░░░░░ 0.5/千行 (↓60%)   │
│                                         │
│  🔍 代码审查发现率                        │
│  ██████░░░░░░░░░░░░░░ 2.1/千行 (↓40%)   │
│                                         │
│  ✅ 代码覆盖率                            │
│  ████████████████░░░░ 82% (↑15%)        │
│                                         │
│  📝 文档同步率                            │
│  ████████████████████ 100% (BDD)        │
│                                         │
└─────────────────────────────────────────┘
```

---

## 8. 扩展与演进

### 短期演进 (6个月)
```
当前状态
    │
    ├─→ 扩展场景库
    │   - 核心业务 100% BDD 覆盖
    │   - 建立场景模板库
    │
    ├─→ ⭐ 沉淀 Skill 规则
    │   - 建立 Domain Skill 库
    │   - 建立 Test Skill 库
    │   - Skill 版本管理
    │
    ├─→ 优化 AI 执行
    │   - Fine-tune 模型理解 Skill
    │   - 提升代码生成质量
    │
    └─→ 工具链完善
        - CI/CD 深度集成
        - 可视化看板
```

### 中期演进 (1年)
```
    ├─→ 智能推荐
    │   - AI 推荐场景补充
    │   - 自动发现缺失用例
    │
    ├─→ ⭐ Skill 市场
    │   - 跨团队 Skill 共享
    │   - Skill 质量评级
    │   - Skill 复用市场
    │
    ├─→ 跨团队协作
    │   - 统一场景库平台
    │   - 场景 + Skill 协同
    │
    └─→ 性能优化
        - 增量生成
        - 并行测试
```

### 长期演进 (3年)
```
    ├─→ ⭐ Skill 自主学习
    │   - AI 从生产数据学习
    │   - 自动优化 Skill 规则
    │   - Skill 质量自动提升
    │
    ├─→ 端到端自动化
    │   - 从需求到部署全自动
    │   - 人类仅做验收
    │
    └─→ 知识图谱
        - 业务知识 → BDD 场景
        - Skill 规则网络
        - 智能辅助决策
```

---

## 总结

**BDD + SDD + AI 架构的核心设计原则**：

1. **⭐ 四层架构**:
   - **业务场景层 (What)**: BDD 描述要做什么
   - **SDD 规则层 (How)**: Skill 定义怎么做（核心竞争力）
   - **AI 执行层 (Execute)**: AI 按规则生成代码
   - **验证层 (Verify)**: 自动化测试持续验证

2. **SDD 是关键桥梁**:
   - BDD 提供结构化需求（What）
   - **SDD 提供转换规则（How）← 这是核心！**
   - AI 执行生成（Execute）
   - **公式**: 高质量代码 = BDD × SDD × AI

3. **持续对齐**: 需求-实现-测试闭环

4. **自动化优先**: 机器做重复，人类做创造

5. **知识沉淀**:
   - 场景库：业务需求的沉淀
   - **⭐ Skill 库：架构规范、业务规则、代码模式的沉淀（组织核心资产）**
   - 代码库：可执行的实现

6. **度量驱动**:
   - BDD 场景覆盖率
   - **Skill 规则复用率**
   - AI 代码生成质量
   - 需求追溯完整性

**关键洞察**:
- BDD 单独使用 → 需求文档化
- BDD + AI → 不稳定的代码生成
- **BDD + SDD + AI → 高质量、可维护、规范统一的代码** ✅

这不仅是技术架构，更是组织能力的系统性提升。**Skill 库是组织最有价值的知识资产**。
