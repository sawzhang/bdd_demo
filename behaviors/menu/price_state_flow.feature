# language: zh-CN

功能: 价格变更单状态流转测试
  作为 系统管理员
  我想要 验证价格变更单的状态流转
  以便 确保状态机逻辑正确

  背景:
    假如 系统中存在以下区域配置:
      | 区域   | 门店数量 |
      | 华东区 | 150     |
    并且 当前"大杯拿铁"的基准价格为36元

  @state-flow
  场景: 完整的正常状态流转
    # 状态1: 待审批
    假如 创建价格变更单:
      | 产品     | 区域   | 调整金额 |
      | 大杯拿铁 | 华东区 | 2元      |
    那么 订单状态应为 "待审批"
    并且 状态历史应记录 "待审批"
    并且 应捕获状态快照

    # 状态2: 已审批
    当 审批人 "李四" 通过该变更单
    那么 订单状态应为 "已审批"
    并且 状态历史应记录 "待审批 → 已审批"
    并且 应记录审批人 "李四"
    并且 应捕获状态快照

    # 状态3: 执行中
    当 系统开始执行价格变更
    那么 订单状态应为 "执行中"
    并且 状态历史应记录 "待审批 → 已审批 → 执行中"
    并且 应记录执行开始时间
    并且 应捕获状态快照

    # 状态4: 已完成
    当 所有门店价格更新成功
    那么 订单状态应为 "已完成"
    并且 状态历史应记录 "待审批 → 已审批 → 执行中 → 已完成"
    并且 应记录执行完成时间
    并且 应捕获状态快照
    并且 应该记录了 4 个状态快照

  @state-flow @failure
  场景: 执行失败的状态流转
    # 创建并审批订单
    假如 创建价格变更单:
      | 产品     | 区域   | 调整金额 |
      | 大杯拿铁 | 华东区 | 2元      |
    并且 审批人 "李四" 通过该变更单
    并且 系统开始执行价格变更
    那么 订单状态应为 "执行中"

    # 执行失败
    当 第50个门店更新失败并触发回滚
    那么 订单状态应为 "执行失败"
    并且 状态历史应记录 "待审批 → 已审批 → 执行中 → 执行失败"
    并且 应记录失败原因 "门店价格同步失败"

  @state-flow @validation
  场景大纲: 状态转换规则验证
    假如 订单当前状态为 "<当前状态>"
    当 执行操作 "<操作>"
    那么 操作结果应为 "<结果>"
    并且 订单最终状态应为 "<最终状态>"

    例子: 合法的状态转换
      | 当前状态 | 操作     | 结果 | 最终状态 |
      | 待审批   | 审批通过 | 成功 | 已审批   |
      | 已审批   | 开始执行 | 成功 | 执行中   |
      | 执行中   | 执行完成 | 成功 | 已完成   |
      | 执行中   | 执行失败 | 成功 | 执行失败 |

    例子: 非法的状态转换
      | 当前状态 | 操作     | 结果 | 最终状态 |
      | 待审批   | 开始执行 | 失败 | 待审批   |
      | 待审批   | 执行完成 | 失败 | 待审批   |
      | 已审批   | 审批通过 | 失败 | 已审批   |
      | 执行中   | 审批通过 | 失败 | 执行中   |
      | 已完成   | 审批通过 | 失败 | 已完成   |
      | 已完成   | 开始执行 | 失败 | 已完成   |

  @state-flow @rollback
  场景: 回滚操作保持中间状态
    假如 创建价格变更单:
      | 产品     | 区域   | 调整金额 |
      | 大杯拿铁 | 华东区 | 2元      |
    并且 审批人 "李四" 通过该变更单
    并且 系统开始执行价格变更

    # 记录执行中的中间状态
    并且 已成功更新 50 个门店
    并且 捕获中间状态数据:
      | 数据项           | 值  |
      | 已更新门店数     | 50  |
      | 待更新门店数     | 100 |
      | 当前处理门店ID   | 51  |

    # 触发回滚
    当 第51个门店更新失败
    那么 应执行回滚操作
    并且 应恢复已更新的 50 个门店价格
    并且 中间状态数据应被保存以供审计

  @state-flow @concurrent
  场景: 并发状态检查
    假如 创建价格变更单:
      | 产品     | 区域   | 调整金额 |
      | 大杯拿铁 | 华东区 | 2元      |

    # 模拟并发操作
    当 多个审批人同时尝试审批
      | 审批人 | 操作时间 |
      | 李四   | 10:00:00 |
      | 王五   | 10:00:01 |
      | 赵六   | 10:00:02 |

    那么 只有第一个审批应该成功
    并且 订单状态应为 "已审批"
    并且 审批人应为 "李四"
    并且 其他审批尝试应被拒绝

  @state-flow @audit
  场景: 状态变更审计日志
    假如 创建价格变更单:
      | 产品     | 区域   | 调整金额 |
      | 大杯拿铁 | 华东区 | 2元      |

    当 审批人 "李四" 通过该变更单
    并且 系统开始执行价格变更
    并且 所有门店价格更新成功

    那么 审计日志应记录以下状态变更:
      | 时间顺序 | 状态     | 操作人 | 操作       |
      | 1        | 待审批   | 张三   | 创建变更单 |
      | 2        | 已审批   | 李四   | 审批通过   |
      | 3        | 执行中   | 系统   | 开始执行   |
      | 4        | 已完成   | 系统   | 执行完成   |
