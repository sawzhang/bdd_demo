# language: zh-CN

功能: 订单流程（含外部依赖）
  作为 顾客
  我想要 下单购买咖啡
  以便 完成购买流程

  背景:
    假如 当前时间为 "2026-02-04 10:00:00"
    并且 系统中存在以下产品:
      | 产品编码      | 产品名称 | 价格  |
      | LATTE-GRANDE | 大杯拿铁 | 36.00 |
      | MOCHA-VENTI  | 超大摩卡 | 42.00 |

  @external-deps @mock
  场景: 正常下单流程（所有外部服务正常）
    # 配置外部依赖 Mock
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关工作正常
    并且 短信服务 API 工作正常

    # 执行业务操作
    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    那么 订单应创建成功
    并且 订单状态应为 "待支付"
    并且 订单金额应为 72.00 元

    # 验证外部服务调用
    并且 应该调用库存服务锁定库存
    并且 应该调用支付网关创建支付
    并且 支付订单号应为 "PAY-ORD-*"

    # 完成支付
    当 用户完成支付
    那么 订单状态应为 "已支付"
    并且 应该向短信服务发送了 1 次请求
    并且 短信内容应包含 "订单支付成功"

  @external-deps @failure
  场景: 库存不足导致下单失败
    假如 库存系统显示 "LATTE-GRANDE" 库存不足
    并且 支付网关工作正常

    当 用户 "张三" 下单购买 10 杯 "大杯拿铁"
    那么 订单应创建失败
    并且 错误信息应为 "库存不足"
    并且 应该调用库存服务检查库存
    并且 不应该调用支付网关

  @external-deps @timeout
  场景: 支付网关超时处理
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关响应超时

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    那么 订单应创建成功
    并且 订单状态应为 "待支付"

    当 用户完成支付
    那么 支付应超时
    并且 订单状态应为 "支付处理中"
    并且 系统应记录支付异常日志
    并且 应该释放已锁定的库存

  @external-deps @retry
  场景: 短信发送失败重试
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关工作正常
    并且 短信服务 API 返回 500 错误
    并且 短信服务配置重试 3 次

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    并且 用户完成支付
    那么 订单状态应为 "已支付"
    并且 应该向短信服务发送了 3 次请求
    并且 系统应记录短信发送失败

  @external-deps @degradation
  场景: 短信服务降级（不影响主流程）
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关工作正常
    并且 短信服务不可用

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    并且 用户完成支付
    那么 订单状态应为 "已支付"
    并且 短信发送应被跳过
    并且 系统应记录降级日志 "短信服务不可用，已降级"

  @external-deps @performance
  场景: 外部服务响应延迟
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关工作正常
    并且 短信服务响应延迟 3000 毫秒

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    并且 用户完成支付
    那么 订单应在 5 秒内创建完成
    并且 系统应记录性能日志 "短信服务响应缓慢"

  @external-deps @compensation
  场景: 支付成功但库存释放失败的补偿
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 支付网关工作正常
    并且 库存释放接口异常

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    那么 订单应创建成功

    当 用户取消订单
    那么 支付应退款成功
    但是 库存释放失败
    并且 系统应创建补偿任务
    并且 补偿任务应包含:
      | 任务类型   | 目标服务   | 重试次数 | 状态   |
      | 释放库存   | 库存系统   | 0        | 待执行 |

  @external-deps @circuit-breaker
  场景大纲: 熔断器保护
    假如 <服务> 连续失败 5 次
    并且 熔断器已开启

    当 用户 "张三" 下单购买 2 杯 "大杯拿铁"
    那么 应该触发熔断
    并且 <服务> 不应该被调用
    并且 应该返回降级响应 "<降级消息>"

    例子:
      | 服务       | 降级消息                     |
      | 库存系统   | 库存服务暂时不可用，请稍后重试 |
      | 支付网关   | 支付服务暂时不可用，请稍后重试 |
      | 短信服务   | 短信通知暂时不可用             |

  @external-deps @integration
  场景: 多个外部服务协同工作
    假如 库存系统显示 "LATTE-GRANDE" 库存充足
    并且 库存系统显示 "MOCHA-VENTI" 库存充足
    并且 支付网关工作正常
    并且 短信服务 API 工作正常
    并且 会员系统显示用户 "张三" 有积分 1000 分

    当 用户 "张三" 下单购买:
      | 产品     | 数量 |
      | 大杯拿铁 | 2    |
      | 超大摩卡 | 1    |
    并且 使用积分 500 分抵扣
    并且 用户完成支付

    那么 订单状态应为 "已支付"
    并且 应该调用库存服务 2 次锁定库存
    并且 应该调用会员系统扣减积分
    并且 应该调用支付网关创建支付
    并且 应该向短信服务发送了 1 次请求
    并且 实际支付金额应为 100.00 元
    并且 积分抵扣应为 10.00 元
